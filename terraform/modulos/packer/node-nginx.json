{
  "variables": {
    "ami_name": "node-nginx-actividad2",
    "ami_description": "AMI with Nginx and Nodejs Application",
    "tags": "Name=NODE-NGINX-AMI,Environment=Development",
    "aws_region": "us-east-1",
    "ami_base": "ami-00ca0754cabb20b45",
    "instance_type": "t2.micro",
    "ssh_username": "ubuntu",
    "ec2_instance_type": "t2.micro",
    "ec2_keypair_name": "danger"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "{{ user `aws_region` }}",
      "source_ami": "{{ user `ami_base` }}",
      "instance_type": "{{ user `instance_type` }}",
      "ssh_username": "{{ user `ssh_username` }}",
      "ami_name": "{{ user `ami_name` }}",
      "ami_description": "{{ user `ami_description` }}",
      "encrypt_boot": false
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sudo apt-get update",
        "sudo apt-get upgrade -y"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "sudo apt-get install -y curl wget gnupg git apt-transport-https ca-certificates"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -",
        "echo 'deb https://dl.yarnpkg.com/debian stable main' | sudo tee /etc/apt/sources.list.d/yarn.list"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -",
        "sudo apt install -y nodejs",
        "node -v"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "sudo apt install -y nginx",
        "sudo systemctl enable nginx",
        "sudo rm -rf /etc/nginx/sites-enabled/default",
        "echo 'server {\n  listen 80;\n  location / {\n    proxy_pass http://localhost:3000;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \"upgrade\";\n    proxy_cache_bypass $http_upgrade;\n  }\n}' | sudo tee /etc/nginx/sites-available/node-app",
        "sudo ln -s /etc/nginx/sites-available/node-app /etc/nginx/sites-enabled/",
        "sudo nginx -t",
        "sudo systemctl daemon-reload",
        "sudo systemctl restart nginx"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "mkdir -p /home/ubuntu/app",
        "sudo chown -R ubuntu:ubuntu /home/ubuntu/app",
        "echo 'const express = require(\"express\");\nconst app = express();\napp.get(\"/\", (req, res) => {\n  res.send(\"Packer - Actividad1 - Jhon Javier Cardona Muñoz ¡Hola desde Node.js y Nginx!\");\n});\napp.listen(3000);' | sudo tee /home/ubuntu/app/app.js",
        "cd /home/ubuntu/app && npm install express",
        "echo '[Unit]\nDescription=Node.js App\nAfter=network.target\n\n[Service]\nUser=ubuntu\nWorkingDirectory=/home/ubuntu/app\nExecStart=/usr/bin/node /home/ubuntu/app/app.js\nRestart=always\n\n[Install]\nWantedBy=multi-user.target' | sudo tee /etc/systemd/system/node-app.service",
        "sudo systemctl enable node-app",
        "sudo systemctl start node-app"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo 'Node and Nginx Stack installed successfully!' "
      ]
    }
  ]
}
